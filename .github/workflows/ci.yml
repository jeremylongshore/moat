# Moat – Continuous Integration
#
# Triggers:
#   - Push to main  (post-merge gate, protects the default branch)
#   - Pull request targeting main  (pre-merge gate, fast feedback)
#
# Job graph:
#   lint ──┐
#           ├── test (needs lint)
#   typecheck  (runs in parallel with lint, continue-on-error while
#               we add annotations incrementally)
#   security   (pip-audit, runs after test to reuse the warm cache)
#
# Design decisions:
#   - All jobs install packages in editable mode (-e) so import paths match
#     the repo layout exactly – no surprises between local and CI.
#   - The test job uploads a coverage artefact so it can be inspected on
#     failure without re-running the suite.
#   - pip-audit is a separate job (not part of `test`) so it never blocks
#     the test result when a transitive dep has a fresh advisory.

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch/PR when a new push arrives.
# This keeps the runner queue clean and gives faster PR feedback.
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:

  # ───────────────────────────────────────────────────────────────────────────
  # lint
  # Ruff: check for errors + enforce formatting (no writes).
  # Fail fast – no point running tests on badly formatted code.
  # ───────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install ruff
        run: pip install ruff>=0.4.0

      - name: ruff check (lint)
        run: ruff check packages/ services/

      - name: ruff format --check (formatting)
        run: ruff format --check packages/ services/

  # ───────────────────────────────────────────────────────────────────────────
  # typecheck
  # mypy – continue-on-error while we ramp up annotations.
  # Reports results as a non-blocking annotation in the PR UI.
  # ───────────────────────────────────────────────────────────────────────────
  typecheck:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    # Intentionally does NOT need lint to finish – runs in parallel.
    continue-on-error: true   # Remove once annotation coverage is solid.

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install all packages (editable) + dev deps
        run: |
          pip install mypy>=1.9.0 pydantic>=2.0.0
          pip install -e packages/core
          pip install -e services/control-plane
          pip install -e services/gateway
          pip install -e services/trust-plane
          pip install -e services/mcp-server

      - name: mypy
        run: mypy packages/ services/ --config-file pyproject.toml

  # ───────────────────────────────────────────────────────────────────────────
  # test
  # Full pytest suite with coverage. Fails the build on any test failure.
  # ───────────────────────────────────────────────────────────────────────────
  test:
    name: Test (pytest + coverage)
    runs-on: ubuntu-latest
    needs: [lint]   # Don't burn runner minutes if lint fails.

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dev dependencies
        run: pip install -r requirements-dev.txt

      - name: Install all packages (editable)
        run: |
          pip install -e packages/core
          pip install -e services/control-plane
          pip install -e services/gateway
          pip install -e services/trust-plane
          pip install -e services/mcp-server

      - name: Run pytest with coverage
        run: |
          pytest \
            --tb=short \
            -v \
            --cov=packages/core/moat_core \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            packages/ services/

      - name: Upload coverage report
        if: always()   # Upload even if tests fail – helps diagnose failures.
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 7

  # ───────────────────────────────────────────────────────────────────────────
  # security
  # pip-audit scans all installed packages for known CVEs.
  # Runs after test so it benefits from the warm pip cache, but is a
  # separate job so a new CVE advisory doesn't mask test results.
  # ───────────────────────────────────────────────────────────────────────────
  security:
    name: Security (pip-audit)
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install pip-audit + all project packages
        run: |
          pip install pip-audit>=2.7.0
          pip install -r requirements-dev.txt
          pip install -e packages/core
          pip install -e services/control-plane
          pip install -e services/gateway
          pip install -e services/trust-plane
          pip install -e services/mcp-server

      - name: Run pip-audit
        # Output as JSON so it can be parsed by security dashboards.
        # --fix is intentionally omitted – we want to review before upgrading.
        run: pip-audit --format=json --output=pip-audit.json || true

      - name: Display audit results
        if: always()
        run: |
          python3 -c "
          import json, sys
          data = json.load(open('pip-audit.json'))
          vulns = data.get('vulnerabilities', [])
          if not vulns:
              print('No known vulnerabilities found.')
              sys.exit(0)
          print(f'WARNING: {len(vulns)} vulnerability/ies found:')
          for v in vulns:
              print(f'  {v[\"name\"]} {v[\"version\"]}: {v[\"id\"]}')
          # Don't fail CI for now – treat as advisory.
          "

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit.json
          retention-days: 30
